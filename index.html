    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bela Art Succulents AI Invoice Generator</title>
        <!-- Favicon and Apple Touch Icon -->
        <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
        <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f0f2f5;
            }
            .container {
                max-width: 900px;
            }
            .input-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #333;
            }
            .input-group input[type="text"],
            .input-group input[type="number"],
            .input-group textarea,
            .input-group select {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                font-size: 1rem;
                color: #374151;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                transition: border-color 0.2s;
            }
            .input-group input:focus,
            .input-group textarea:focus,
            .input-group select:focus {
                outline: none;
                border-color: #6366f1;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            }
            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s, box-shadow 0.2s;
            }
            .btn-primary {
                background-color: #6366f1;
                color: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .btn-primary:hover {
                background-color: #4f46e5;
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            }
            .btn-secondary {
                background-color: #e5e7eb;
                color: #374151;
                border: 1px solid #d1d5db;
            }
            .btn-secondary:hover {
                background-color: #d1d5db;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.75rem;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
            }
            .invoice-table th {
                background-color: #f9fafb;
                font-weight: 600;
                color: #4b5563;
            }
            .invoice-table tfoot td {
                font-weight: 600;
            }
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1000; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 500px;
                position: relative;
            }
            .close-button {
                position: absolute;
                top: 10px;
                right: 20px;
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
            }
            .loading-spinner {
                border: 4px solid #f3f3f3; /* Light grey */
                border-top: 4px solid #6366f1; /* Blue */
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            /* Styles for editable items table */
            .editable-item-row td {
                padding: 0.5rem;
                vertical-align: middle;
            }
            .editable-item-row input[type="text"],
            .editable-item-row input[type="number"] {
                padding: 0.3rem 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 0.25rem;
                width: 100%;
            }
            .editable-item-row button {
                background-color: #ef4444;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.875rem;
            }
            .editable-item-row button:hover {
                background-color: #dc2626;
            }

            /* New API Key Modal Styles */
            #api-key-modal .modal-content {
                width: 90%;
                max-width: 450px;
            }
            #api-key-modal input {
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                padding: 0.75rem;
                width: 100%;
                margin-top: 0.5rem;
                margin-bottom: 1rem;
            }
            #api-key-modal button {
                background-color: #10b981; /* Green color for submit */
                color: white;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            #api-key-modal button:hover {
                background-color: #059669;
            }
            #api-key-modal p.warning {
                font-size: 0.875rem;
                color: #ef4444;
                margin-top: 0.75rem;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen flex items-center justify-content-center p-4">
        <div class="container bg-white rounded-lg shadow-xl p-6 md:p-8 space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Bela Art Succulents AI Invoice Generator</h1>

            <!-- Company Information Section -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Your Company Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="company-name" class="text-blue-700">Company Name:</label>
                        <input type="text" id="company-name" placeholder="Your Company Inc." value="Bela Art Succulents" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="company-logo" class="text-blue-700">Company Logo:</label>
                        <input type="file" id="company-logo" accept="image/*" class="w-full text-blue-700 p-2 border border-blue-300 rounded-md">
                        <div class="mt-2" id="logo-preview-container">
                            <!-- Logo preview will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Upload Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. Upload Receipt Photo(s)</h2>
                <div class="input-group mb-4">
                    <label for="receipt-photo" class="text-gray-700">Select Receipt Image(s):</label>
                    <!-- Added 'multiple' attribute here -->
                    <input type="file" id="receipt-photo" accept="image/*" multiple class="w-full text-gray-700 p-2 border border-gray-300 rounded-md">
                </div>
                <button id="extract-data-btn" class="btn btn-primary w-full flex items-center justify-content-center gap-2">
                    Extract Data from Receipt(s)
                    <div id="extract-loading-spinner" class="loading-spinner hidden"></div>
                </button>
                <div id="extraction-status" class="mt-4 text-sm text-gray-600"></div>
            </div>

            <!-- Manual Item Entry Section -->
            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-700 mb-4">2. Add/Edit Invoice Items</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div class="input-group md:col-span-2">
                        <label for="manual-description" class="text-purple-700">Description:</label>
                        <input type="text" id="manual-description" placeholder="Service fee, Product XYZ" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="manual-quantity" class="text-purple-700">Qty:</label>
                        <input type="number" id="manual-quantity" value="1" min="0" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="manual-unit-price" class="text-purple-700">Unit Price ($):</label>
                        <input type="number" id="manual-unit-price" value="0.00" min="0" step="0.01" class="mt-1">
                    </div>
                    <button id="add-manual-item-btn" class="btn btn-primary bg-purple-600 hover:bg-purple-700 mt-2 md:mt-0">Add Item Manually</button>
                </div>
                <!-- New: Clear All Items button -->
                <button id="clear-all-items-btn" class="btn btn-secondary w-full mt-4 bg-red-400 hover:bg-red-500 text-white">Clear All Items</button>


                <div id="invoice-items-management" class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Current Invoice Line Items:</h3>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="w-1/2 text-left p-2">Description</th>
                                <th class="w-1/6 text-left p-2">Qty</th>
                                <th class="w-1/6 text-left p-2">Unit Price</th>
                                <th class="w-1/6 text-left p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="editable-items-body">
                            <!-- Editable items will be injected here -->
                            <tr><td colspan="4" class="text-center text-gray-500 p-4" id="no-items-message">No items added yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Invoice Details Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">3. Invoice Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="client-name" class="text-gray-700">Client Name:</label>
                        <input type="text" id="client-name" placeholder="John Doe Services" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="clientEmail" class="text-gray-700">Customer Email:</label>
                        <input type="email" id="clientEmail" placeholder="customer@example.com" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="invoice-date" class="text-gray-700">Invoice Date:</label>
                        <input type="date" id="invoice-date" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="due-date" class="text-gray-700">Due Date:</label>
                        <input type="date" id="due-date" class="mt-1">
                    </div>
                </div>

                <div class="input-group mb-4">
                    <label for="invoiceDetails" class="text-gray-700">Additional Invoice Notes:</label>
                    <textarea id="invoiceDetails" placeholder="Add any specific notes or terms for this invoice here..." rows="4" class="mt-1"></textarea>
                </div>


                <h3 class="text-xl font-semibold text-gray-700 mb-3">Labor Cost</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="labor-hours" class="text-gray-700">Labor Hours:</label>
                        <input type="number" id="labor-hours" value="0" min="0" step="0.5" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="hourly-rate" class="text-gray-700">Hourly Rate ($):</label>
                        <input type="number" id="hourly-rate" value="30.00" min="0" step="0.01" class="mt-1">
                    </div>
                </div>
            </div>

            <!-- Generate Invoice Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">4. Generate Invoice</h2>
                <button id="generate-invoice-btn" class="btn btn-primary w-full flex items-center justify-content-center gap-2">
                    Generate Invoice
                    <div id="generate-loading-spinner" class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- Invoice Display Section -->
            <div id="invoice-output" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                    <div>
                        <img id="invoice-company-logo" src="" alt="Company Logo" class="h-16 mb-2 object-contain" onerror="this.style.display='none'" style="display:none;">
                        <h2 class="text-2xl font-bold text-gray-800" id="display-company-name"></h2>
                    </div>
                    <div class="text-right mt-4 md:mt-0">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Invoice</h2>
                        <p class="text-sm text-gray-600"><strong>Client Name:</strong> <span id="display-client-name"></span></p>
                        <p class="text-sm text-gray-600"><strong>Invoice Date:</strong> <span id="display-invoice-date"></span></p>
                        <p class="text-sm text-gray-600"><strong>Due Date:</strong> <span id="display-due-date"></span></p>
                    </div>
                </div>

                <table class="invoice-table w-full border-collapse mt-6">
                    <thead>
                        <tr>
                            <th class="w-1/2">Description</th>
                            <th class="w-1/6">Qty</th>
                            <th class="w-1/6">Unit Price</th>
                            <th class="w-1/6 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="final-invoice-items-body">
                        <!-- Invoice items will be injected here -->
                    </tbody>
                    <tfoot>
                        <!-- New total rows -->
                        <tr>
                            <td colspan="3" class="text-right">Materials Subtotal:</td>
                            <td class="text-right" id="invoice-materials-subtotal"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-right">Labor Total:</td>
                            <td class="text-right" id="invoice-labor-total"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-right">Tax:</td>
                            <td class="text-right" id="invoice-tax"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-right font-bold text-lg">Grand Total:</td>
                            <td class="text-right font-bold text-lg" id="invoice-grand-total"></td>
                        </tr>
                    </tfoot>
                </table>
                <!-- Send Invoice Email Button (Now handled via JavaScript event listener) -->
                <button class="btn btn-primary mt-6 w-full md:w-auto" id="sendEmailButton">
                    Send Invoice to Customer Email
                </button>
            </div>

            <!-- Message/Modal Box -->
            <div id="message-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="close-modal-btn">&times;</span>
                    <p id="modal-message" class="text-lg text-gray-800 text-center"></p>
                </div>
            </div>

            <!-- NEW: API Key Input Modal -->
            <div id="api-key-modal" class="modal">
                <div class="modal-content">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Enter Google Gemini API Key</h3>
                    <p class="text-gray-700 mb-3">To enable AI receipt data extraction, please enter your Google Gemini API Key. This key will only be stored temporarily in your browser's session and will not be saved or sent to any server.</p>
                    <input type="text" id="gemini-api-key-input" placeholder="Paste your API Key here..." class="w-full p-2 border rounded-md">
                    <button id="save-api-key-btn" class="btn btn-primary w-full mt-4">Save Key & Continue</button>
                    <p class="warning mt-2">**Warning:** Do not share your API key publicly. For production, consider using a secure backend proxy.</p>
                </div>
            </div>

        </div>

        <script>
            let invoiceLineItems = []; // Unified array to store all invoice items (extracted + manual)
            let companyLogoBase64 = null; // To store the base64 string of the company logo
            let geminiApiKey = sessionStorage.getItem('geminiApiKey') || ''; // Load API key from session storage

            // Get DOM elements
            const companyNameInput = document.getElementById('company-name');
            const companyLogoInput = document.getElementById('company-logo');
            const logoPreviewContainer = document.getElementById('logo-preview-container');

            const receiptPhotoInput = document.getElementById('receipt-photo');
            const extractDataBtn = document.getElementById('extract-data-btn');
            const extractLoadingSpinner = document.getElementById('extract-loading-spinner');
            const extractionStatusDiv = document.getElementById('extraction-status');

            const manualDescriptionInput = document.getElementById('manual-description');
            const manualQuantityInput = document.getElementById('manual-quantity');
            const manualUnitPriceInput = document.getElementById('manual-unit-price');
            const addManualItemBtn = document.getElementById('add-manual-item-btn');
            const clearAllItemsBtn = document.getElementById('clear-all-items-btn'); // New clear button
            const editableItemsBody = document.getElementById('editable-items-body');
            const noItemsMessage = document.getElementById('no-items-message');


            const clientNameInput = document.getElementById('client-name');
            const clientEmailInput = document.getElementById('clientEmail'); 
            const invoiceDateInput = document.getElementById('invoice-date');
            const dueDateInput = document.getElementById('due-date');
            const invoiceDetailsTextarea = document.getElementById('invoiceDetails'); 
            const laborHoursInput = document.getElementById('labor-hours');
            const hourlyRateInput = document.getElementById('hourly-rate'); 
            const generateInvoiceBtn = document.getElementById('generate-invoice-btn');
            const generateLoadingSpinner = document.getElementById('generate-loading-spinner');

            const invoiceOutputDiv = document.getElementById('invoice-output');
            const displayCompanyName = document.getElementById('display-company-name');
            const invoiceCompanyLogo = document.getElementById('invoice-company-logo');
            const displayClientName = document.getElementById('display-client-name');
            const displayInvoiceDate = document.getElementById('display-invoice-date');
            const displayDueDate = document.getElementById('display-due-date');
            const finalInvoiceItemsBody = document.getElementById('final-invoice-items-body');
            const invoiceMaterialsSubtotal = document.getElementById('invoice-materials-subtotal'); // New
            const invoiceLaborTotal = document.getElementById('invoice-labor-total'); // New
            const invoiceTax = document.getElementById('invoice-tax');
            const invoiceGrandTotal = document.getElementById('invoice-grand-total');

            const sendEmailButton = document.getElementById('sendEmailButton'); 

            const messageModal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            const apiKeyModal = document.getElementById('api-key-modal');
            const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');

            // Set default dates and company name
            window.onload = function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(today.getDate()).padStart(2, '0');
                invoiceDateInput.value = `${year}-${month}-${day}`;

                // Set due date to 7 days from now
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + 7);
                const dueYear = dueDate.getFullYear();
                const dueMonth = String(dueDate.getMonth() + 1).padStart(2, '0');
                const dueDay = String(dueDate.getDate()).padStart(2, '0');
                dueDateInput.value = `${dueYear}-${dueMonth}-${dueDay}`;
                renderEditableItems(); // Initial render for empty state
            };

            // Function to show custom message modal
            function showMessage(message) {
                modalMessage.textContent = message;
                messageModal.style.display = 'flex';
                modalMessage.style.textAlign = 'center';
            }

            // Function to hide custom message modal
            closeModalBtn.onclick = function() {
                messageModal.style.display = 'none';
            }

            // Close general message modal if user clicks outside of it
            window.onclick = function(event) {
                if (event.target == messageModal) {
                    messageModal.style.display = 'none';
                }
            }

            // Handle saving API Key from the new modal
            saveApiKeyBtn.addEventListener('click', () => {
                const key = geminiApiKeyInput.value.trim();
                if (key) {
                    geminiApiKey = key;
                    sessionStorage.setItem('geminiApiKey', key); // Store for current session
                    apiKeyModal.style.display = 'none'; // Hide the modal
                    // After saving, if there are files already selected, try to process them
                    if (receiptPhotoInput.files.length > 0) {
                        processSelectedReceipts(); // Call a new function to process multiple files
                    }
                } else {
                    showMessage("Please enter a valid Gemini API Key.");
                }
            });

            // Function to render the editable invoice items table
            function renderEditableItems() {
                editableItemsBody.innerHTML = ''; // Clear current list
                if (invoiceLineItems.length === 0) {
                    noItemsMessage.style.display = 'table-row';
                } else {
                    noItemsMessage.style.display = 'none';
                    invoiceLineItems.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'editable-item-row border-b border-gray-100';
                        row.innerHTML = `
                            <td><input type="text" value="${item.description || ''}" data-index="${index}" data-field="description" class="p-2 border rounded-md w-full"></td>
                            <td><input type="number" value="${item.quantity || 1}" min="1" step="1" data-index="${index}" data-field="quantity" class="p-2 border rounded-md w-full"></td>
                            <td><input type="number" value="${(item.unit_price || 0).toFixed(2)}" min="0" step="0.01" data-index="${index}" data-field="unit_price" class="p-2 border rounded-md w-full"></td>
                            <td><button data-index="${index}" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md">Delete</button></td>
                        `;
                        editableItemsBody.appendChild(row);
                    });

                    // Add event listeners for editing and deleting
                    editableItemsBody.querySelectorAll('input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            const field = e.target.dataset.field;
                            let value = e.target.value;

                            if (field === 'quantity' || field === 'unit_price') {
                                value = parseFloat(value) || 0;
                                if (field === 'quantity' && value < 1) value = 1; 
                                if (field === 'unit_price' && value < 0) value = 0; 
                            }
                            invoiceLineItems[index][field] = value;
                            invoiceLineItems[index].total_price = (invoiceLineItems[index].quantity || 0) * (invoiceLineItems[index].unit_price || 0);
                        });
                    });

                    editableItemsBody.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            invoiceLineItems.splice(index, 1); 
                            renderEditableItems(); 
                        });
                    });
                }
            }

            // Event listener for "Clear All Items" button
            clearAllItemsBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear all invoice items? This cannot be undone.")) {
                    invoiceLineItems = []; // Empty the array
                    renderEditableItems(); // Re-render to show empty state
                    extractionStatusDiv.textContent = 'All items cleared.';
                    extractionStatusDiv.classList.remove('text-green-600', 'text-red-600');
                    extractionStatusDiv.classList.add('text-gray-600');
                }
            });


            // Event listener for company logo input
            companyLogoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        companyLogoBase64 = e.target.result; 
                        const img = document.createElement('img');
                        img.src = companyLogoBase64;
                        img.alt = "Company Logo Preview";
                        img.className = "h-12 object-contain rounded"; 
                        logoPreviewContainer.innerHTML = ''; 
                        logoPreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else {
                    companyLogoBase64 = null;
                    logoPreviewContainer.innerHTML = '';
                }
            });

            // Event listener for manual item addition
            addManualItemBtn.addEventListener('click', () => {
                const description = manualDescriptionInput.value.trim();
                const quantity = parseFloat(manualQuantityInput.value) || 1;
                const unitPrice = parseFloat(manualUnitPriceInput.value) || 0;

                if (!description || quantity <= 0 || unitPrice < 0) {
                    showMessage("Please enter a valid description, quantity (must be > 0), and unit price for manual item.");
                    return;
                }

                const newItem = {
                    description: description,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total_price: quantity * unitPrice 
                };

                invoiceLineItems.push(newItem);
                renderEditableItems(); 
                manualDescriptionInput.value = '';
                manualQuantityInput.value = '1';
                manualUnitPriceInput.value = '0.00';
            });

            // Function to process a single receipt file with AI
            async function processSingleReceipt(file) {
                console.log(`Processing file: ${file.name}`);
                extractLoadingSpinner.classList.remove('hidden');
                extractionStatusDiv.textContent = `Extracting data from ${file.name}...`;
                extractionStatusDiv.classList.remove('text-red-600', 'text-green-600');
                extractionStatusDiv.classList.add('text-gray-600');

                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64ImageData = reader.result.split(',')[1];

                        try {
                            const prompt = `Analyze the provided receipt image. Your primary goal is to extract itemized lists (description, quantity, unit price, and total price for each item), along with the overall subtotal, tax, and grand total.
                            * **Be resilient to image quality:** Even if parts are blurry or incomplete, attempt to infer the most probable values.
                            * **Prioritize numerical accuracy:** All price, quantity, and total fields MUST be valid numbers (floats). If a numerical value cannot be confidently extracted or inferred, use 0.
                            * **Handle missing data:** If a description, quantity, or unit price for an item is missing, use "N/A" for strings, or 0 for numbers, but still include the item if its existence is clear.
                            * **Strict JSON Format:** Your response MUST be a JSON object conforming to this schema, even if some values are null/0 or the 'items' array is empty. ENCLOSE THE ENTIRE JSON OUTPUT WITHIN A MARKDOWN CODE BLOCK (e.g., \`\`\`json { ... } \`\`\`):
                                {
                                "items": [
                                    {"description": "string", "quantity": number, "unit_price": number, "total_price": number}
                                ],
                                "subtotal": number,
                                "tax": number,
                                "grand_total": number
                                }`;

                            let chatHistory = [];
                            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                            const payload = {
                                contents: [
                                    {
                                        role: "user",
                                        parts: [
                                            { text: prompt },
                                            {
                                                inlineData: {
                                                    mimeType: file.type,
                                                    data: base64ImageData
                                                }
                                            }
                                        ] 
                                    }
                                ], 
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    responseSchema: {
                                        type: "OBJECT",
                                        properties: {
                                            "items": {
                                                "type": "ARRAY",
                                                "items": {
                                                    "type": "OBJECT",
                                                    "properties": {
                                                        "description": { "type": "STRING" },
                                                        "quantity": { "type": "NUMBER" },
                                                        "unit_price": { "type": "NUMBER" },
                                                        "total_price": { "type": "NUMBER" }
                                                    }
                                                }
                                            },
                                            "subtotal": { "type": "NUMBER" },
                                            "tax": { "type": "NUMBER" },
                                            "grand_total": { "type": "NUMBER" }
                                        }
                                    }
                                }
                            };

                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`; 

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (response.ok && result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                const rawJsonText = result.candidates[0].content.parts[0].text;
                                console.log('Gemini API extracted raw text:', rawJsonText);

                                // Extract JSON from markdown code block if present
                                const jsonMatch = rawJsonText.match(/```json\n([\s\S]*?)\n```/);
                                let jsonString;
                                if (jsonMatch && jsonMatch[1]) {
                                    jsonString = jsonMatch[1];
                                    console.log('Extracted JSON from markdown block:', jsonString);
                                } else {
                                    jsonString = rawJsonText; // Fallback if no markdown block
                                    console.log('No markdown block found, using raw text as JSON:', jsonString);
                                }
                                
                                const parsedData = JSON.parse(jsonString);
                                resolve({ success: true, items: parsedData.items || [], file: file.name });
                            } else {
                                let errorMessage = `Failed to extract data from ${file.name}. AI response was empty or malformed.`;
                                if (result.error && result.error.message) {
                                    errorMessage += ` Error: ${result.error.message}`;
                                }
                                showMessage(errorMessage);
                                resolve({ success: false, error: errorMessage, file: file.name });
                            }
                        } catch (error) {
                            console.error(`Error processing ${file.name}:`, error);
                            showMessage(`An error occurred processing ${file.name}. Error: ${error.message}`);
                            resolve({ success: false, error: error.message, file: file.name });
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            // New function to handle processing multiple selected receipts
            async function processSelectedReceipts() {
                const files = receiptPhotoInput.files;
                if (files.length === 0) {
                    showMessage("No receipt photos selected for extraction.");
                    extractDataBtn.disabled = false;
                    extractLoadingSpinner.classList.add('hidden');
                    return;
                }

                if (!geminiApiKey) {
                    apiKeyModal.style.display = 'flex';
                    geminiApiKeyInput.focus();
                    extractDataBtn.disabled = false;
                    extractLoadingSpinner.classList.add('hidden');
                    extractionStatusDiv.textContent = 'Enter API Key to proceed.';
                    extractionStatusDiv.classList.remove('text-green-600');
                    extractionStatusDiv.classList.add('text-red-600');
                    return;
                }

                extractDataBtn.disabled = true;
                extractLoadingSpinner.classList.remove('hidden');
                extractionStatusDiv.textContent = `Processing ${files.length} receipt(s)...`;
                extractionStatusDiv.classList.remove('text-red-600', 'text-green-600');
                extractionStatusDiv.classList.add('text-gray-600');

                let successfulExtractions = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const result = await processSingleReceipt(file);
                    if (result.success) {
                        invoiceLineItems.push(...result.items);
                        successfulExtractions++;
                    }
                    extractionStatusDiv.textContent = `Processed ${i + 1}/${files.length} receipts.`;
                }

                if (successfulExtractions > 0) {
                    extractionStatusDiv.textContent = `Successfully extracted items from ${successfulExtractions} of ${files.length} receipt(s). Review and edit below.`;
                    extractionStatusDiv.classList.add('text-green-600');
                    extractionStatusDiv.classList.remove('text-red-600');
                } else {
                    extractionStatusDiv.textContent = `No items extracted from any of the ${files.length} receipt(s). Please try clearer photos or add items manually.`;
                    extractionStatusDiv.classList.add('text-red-600');
                    extractionStatusDiv.classList.remove('text-green-600');
                }
                renderEditableItems(); // Re-render the editable list with all accumulated items
                extractDataBtn.disabled = false;
                extractLoadingSpinner.classList.add('hidden');
            }


            // Event listener for receipt photo upload and data extraction
            extractDataBtn.addEventListener('click', () => {
                console.log('Extract Data button clicked.');
                processSelectedReceipts(); // Call the new multi-file processing function
            });


            // Event listener for invoice generation
            generateInvoiceBtn.addEventListener('click', () => {
                generateInvoiceBtn.disabled = true;
                generateLoadingSpinner.classList.remove('hidden');
                invoiceOutputDiv.classList.add('hidden'); // Hide previous invoice

                const companyName = companyNameInput.value.trim();
                const clientName = clientNameInput.value.trim();
                const invoiceDate = invoiceDateInput.value;
                const dueDate = dueDateInput.value;
                const laborHours = parseFloat(laborHoursInput.value) || 0;
                const hourlyRate = parseFloat(hourlyRateInput.value) || 0;

                if (!companyName || !clientName || !invoiceDate || !dueDate) {
                    showMessage("Please fill in all required invoice details (Company Name, Client Name, Invoice Date, Due Date).");
                    generateInvoiceBtn.disabled = false;
                    generateLoadingSpinner.classList.add('hidden');
                    return;
                }

                if (invoiceLineItems.length === 0 && (laborHours * hourlyRate) === 0) {
                     showMessage("Please add at least one item (manual or extracted) or provide labor hours to generate an invoice.");
                     generateInvoiceBtn.disabled = false;
                     generateLoadingSpinner.classList.add('hidden');
                     return;
                }

                // Calculate labor total
                const laborTotal = laborHours * hourlyRate;

                // Clear previous items in the final invoice display
                finalInvoiceItemsBody.innerHTML = '';

                let materialsSubtotal = 0; // Renamed for clarity

                // Add all items from invoiceLineItems to the final invoice
                if (invoiceLineItems.length > 0) {
                    invoiceLineItems.forEach(item => {
                        const quantity = item.quantity || 1;
                        const unitPrice = item.unit_price || 0;
                        const itemTotalPrice = quantity * unitPrice;

                        materialsSubtotal += itemTotalPrice;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.description || 'N/A'}</td>
                            <td>${quantity}</td>
                            <td>$${unitPrice.toFixed(2)}</td>
                            <td class="text-right">$${itemTotalPrice.toFixed(2)}</td>
                        `;
                        finalInvoiceItemsBody.appendChild(row);
                    });
                }
                
                // Add a visual separator if both materials and labor exist
                if (materialsSubtotal > 0 && laborTotal > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `<td colspan="4" class="py-2 bg-gray-50 text-gray-700 text-center text-sm">--- End of Material Items ---</td>`;
                    finalInvoiceItemsBody.appendChild(separatorRow);
                }

                // Add labor cost as an item if applicable
                if (laborTotal > 0) {
                    const laborRow = document.createElement('tr');
                    laborRow.innerHTML = `
                        <td>Labor (${laborHours} hours @ $${hourlyRate.toFixed(2)}/hr)</td>
                        <td>1</td>
                        <td>$${laborTotal.toFixed(2)}</td>
                        <td class="text-right">$${laborTotal.toFixed(2)}</td>
                    `;
                    finalInvoiceItemsBody.appendChild(laborRow);
                } else if (invoiceLineItems.length === 0) {
                     // If no items extracted and no labor, show a message in the invoice itself
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="4" class="text-center text-gray-500">No items to display on invoice.</td>
                    `;
                    finalInvoiceItemsBody.appendChild(row);
                }


                const tax = 0; 
                const grandTotal = materialsSubtotal + laborTotal + tax; // Sum materials and labor for grand total

                // Populate invoice display with company name and logo
                displayCompanyName.textContent = companyName;
                if (companyLogoBase64) {
                    invoiceCompanyLogo.src = companyLogoBase64;
                    invoiceCompanyLogo.style.display = 'block';
                } else {
                    invoiceCompanyLogo.style.display = 'none'; // Hide if no logo
                }
                displayClientName.textContent = clientName;
                displayInvoiceDate.textContent = invoiceDate;
                displayDueDate.textContent = dueDate;
                invoiceMaterialsSubtotal.textContent = `$${materialsSubtotal.toFixed(2)}`; // Set new material subtotal
                invoiceLaborTotal.textContent = `$${laborTotal.toFixed(2)}`; // Set new labor total
                invoiceTax.textContent = `No Tax`; 
                invoiceGrandTotal.textContent = `$${grandTotal.toFixed(2)}`;

                invoiceOutputDiv.classList.remove('hidden');

                generateInvoiceBtn.disabled = false;
                generateLoadingSpinner.classList.add('hidden');
            });

            // The user-provided sendInvoiceEmail function, modified to use showMessage
            async function sendInvoiceEmail(toEmail, subject, bodyContent) {
                try {
                    console.log('Attempting to send email...');
                    console.log('To:', toEmail);
                    console.log('Subject:', subject);
                    // console.log('Body (HTML):', bodyContent); // Log the full body for debugging if needed

                    // !!! IMPORTANT: Replace 'YOUR_GOOGLE_CLOUD_FUNCTION_URL_HERE' with the actual URL you got from gcloud deployment !!!
                    const googleCloudFunctionUrl = 'YOUR_GOOGLE_CLOUD_FUNCTION_URL_HERE'; 

                    const response = await fetch(googleCloudFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: toEmail,
                            subject: subject,
                            body: bodyContent // Sending HTML content here
                        }),
                    });

                    console.log('Response status from Google Cloud Function:', response.status);
                    const data = await response.json();
                    console.log('Response data from Google Cloud Function:', data);

                    if (response.ok) {
                        showMessage(data.message || 'Email sent successfully!');
                        console.log('Email send success:', data.message);
                    } else {
                        showMessage(`Failed to send email: ${data.message || response.statusText}. Please check Google Cloud Function logs.`);
                        console.error('Email send failed (frontend received error from backend):', data.message || response.statusText);
                    }
                } catch (error) {
                    console.error('Email send failed (frontend fetch error):', error);
                    showMessage('Failed to send email. A network error or unhandled problem occurred. Check browser console.');
                }
            }

            // --- Event Listener for Send Email Button (Replaced onclick) ---
            sendEmailButton.addEventListener('click', () => {
                const companyName = document.getElementById('company-name').value.trim();
                const clientName = document.getElementById('client-name').value.trim();
                const clientEmail = document.getElementById('clientEmail').value.trim();
                const invoiceDate = document.getElementById('invoice-date').value;
                const dueDate = document.getElementById('due-date').value;
                const grandTotal = document.getElementById('invoice-grand-total').textContent;
                const materialsSubtotal = document.getElementById('invoice-materials-subtotal').textContent;
                const laborTotal = document.getElementById('invoice-labor-total').textContent;
                const additionalNotes = document.getElementById('invoiceDetails').value.trim();

                if (!clientEmail) { showMessage('Please enter the customer\'s email address.'); return; }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(clientEmail)) { showMessage('Please enter a valid email address for the customer.'); return; }
                if (!companyName || !clientName || !invoiceDate || !grandTotal) { showMessage('Please generate the invoice first and ensure all details are filled.'); return; }

                const subject = `${companyName} - Invoice for ${clientName} on ${invoiceDate}`;
                let htmlBody = `
                    <html>
                    <head>
                        <style>
                            body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; }
                            h1, h2 { color: #6366f1; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
                            th { background-color: #f9fafb; font-weight: 600; }
                            .total-row td { font-weight: bold; }
                            .text-right { text-align: right; }
                        </style>
                    </head>
                    <body>
                        <h1 style='text-align: center;'>Invoice from ${companyName}</h1>
                        <p><strong>Client Name:</strong> ${clientName}</p>
                        <p><strong>Invoice Date:</strong> ${invoiceDate}</p>
                        <p><strong>Due Date:</strong> ${dueDate}</p>
                        ${additionalNotes ? `<p><strong>Additional Notes:</strong></p><p>${additionalNotes.replace(/\\n/g, '<br>')}</p>` : ''}
                        
                        <h2>Invoice Details:</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th class='text-right'>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                invoiceLineItems.forEach(item => {
                    const qty = item.quantity || 1;
                    const price = (item.unit_price || 0).toFixed(2);
                    const total = (qty * parseFloat(price)).toFixed(2);
                    htmlBody += `
                                <tr>
                                    <td>${item.description || 'N/A'}</td>
                                    <td>${qty}</td>
                                    <td>$${price}</td>
                                    <td class='text-right'>$${total}</td>
                                </tr>
                    `;
                });

                const laborHours = parseFloat(document.getElementById('labor-hours').value) || 0;
                const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
                const laborTotalVal = laborHours * hourlyRate; // Use a new variable to avoid conflict with `laborTotal` from element

                if (invoiceLineItems.length > 0 && laborTotalVal > 0) {
                    htmlBody += `
                        <tr>
                            <td colspan="4" style="text-align: center; background-color: #f9fafb; font-weight: 600; padding: 10px;">--- End of Material Items ---</td>
                        </tr>
                    `;
                }


                if (laborTotalVal > 0) {
                    htmlBody += `
                                <tr>
                                    <td>Labor (${laborHours} hours @ $${hourlyRate.toFixed(2)}/hr)</td>
                                    <td>1</td>
                                    <td>$${laborTotalVal.toFixed(2)}</td>
                                    <td class='text-right'>$${laborTotalVal.toFixed(2)}</td>
                                </tr>
                    `;
                }

                htmlBody += `
                            </tbody>
                            <tfoot>
                                <tr class='total-row'>
                                    <td colspan='3' class='text-right'>Materials Subtotal:</td>
                                    <td class='text-right'>${materialsSubtotal}</td>
                                </tr>
                                <tr class='total-row'>
                                    <td colspan='3' class='text-right'>Labor Total:</td>
                                    <td class='text-right'>${laborTotal}</td>
                                </tr>
                                <tr class='total-row'>
                                    <td colspan='3' class='text-right'>Tax:</td>
                                    <td class='text-right'>No Tax</td>
                                </tr>
                                <tr class='total-row'>
                                    <td colspan='3' class='text-right'>Grand Total:</td>
                                    <td class='text-right'>${grandTotal}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <p style='margin-top: 20px;'>Please let us know if you have any questions.</p>
                        <p>Thank you for your business!</p>
                        <p>${companyName}</p>
                    </body>
                    </html>
                `;

                // Call the sendInvoiceEmail function with the generated HTML body
                sendInvoiceEmail(clientEmail, subject, htmlBody);
            });
        </script>
    </body>
    </html>

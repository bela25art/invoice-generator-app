    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bela Art Succulents AI Invoice Generator</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f0f2f5;
            }
            .container {
                max-width: 900px;
            }
            .input-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #333;
            }
            .input-group input[type="text"],
            .input-group input[type="number"],
            .input-group textarea,
            .input-group select {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                font-size: 1rem;
                color: #374151;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                transition: border-color 0.2s;
            }
            .input-group input:focus,
            .input-group textarea:focus,
            .input-group select:focus {
                outline: none;
                border-color: #6366f1;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            }
            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s, box-shadow 0.2s;
            }
            .btn-primary {
                background-color: #6366f1;
                color: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .btn-primary:hover {
                background-color: #4f46e5;
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            }
            .btn-secondary {
                background-color: #e5e7eb;
                color: #374151;
                border: 1px solid #d1d5db;
            }
            .btn-secondary:hover {
                background-color: #d1d5db;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.75rem;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
            }
            .invoice-table th {
                background-color: #f9fafb;
                font-weight: 600;
                color: #4b5563;
            }
            .invoice-table tfoot td {
                font-weight: 600;
            }
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1000; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 500px;
                position: relative;
            }
            .close-button {
                position: absolute;
                top: 10px;
                right: 20px;
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
            }
            .loading-spinner {
                border: 4px solid #f3f3f3; /* Light grey */
                border-top: 4px solid #6366f1; /* Blue */
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            /* Styles for editable items table */
            .editable-item-row td {
                padding: 0.5rem;
                vertical-align: middle;
            }
            .editable-item-row input[type="text"],
            .editable-item-row input[type="number"] {
                padding: 0.3rem 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 0.25rem;
                width: 100%;
            }
            .editable-item-row button {
                background-color: #ef4444;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.875rem;
            }
            .editable-item-row button:hover {
                background-color: #dc2626;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
        <div class="container bg-white rounded-lg shadow-xl p-6 md:p-8 space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Bela Art Succulents AI Invoice Generator</h1>

            <!-- Company Information Section -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Your Company Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="company-name" class="text-blue-700">Company Name:</label>
                        <input type="text" id="company-name" placeholder="Your Company Inc." value="Bela Art Succulents" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="company-logo" class="text-blue-700">Company Logo:</label>
                        <input type="file" id="company-logo" accept="image/*" class="w-full text-blue-700 p-2 border border-blue-300 rounded-md">
                        <div class="mt-2" id="logo-preview-container">
                            <!-- Logo preview will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Upload Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. Upload Receipt Photo</h2>
                <div class="input-group mb-4">
                    <label for="receipt-photo" class="text-gray-700">Select Receipt Image:</label>
                    <input type="file" id="receipt-photo" accept="image/*" class="w-full text-gray-700 p-2 border border-gray-300 rounded-md">
                </div>
                <button id="extract-data-btn" class="btn btn-primary w-full flex items-center justify-center gap-2">
                    Extract Data from Receipt
                    <div id="extract-loading-spinner" class="loading-spinner hidden"></div>
                </button>
                <div id="extraction-status" class="mt-4 text-sm text-gray-600"></div>
            </div>

            <!-- Manual Item Entry Section -->
            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-700 mb-4">2. Add/Edit Invoice Items</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div class="input-group md:col-span-2">
                        <label for="manual-description" class="text-purple-700">Description:</label>
                        <input type="text" id="manual-description" placeholder="Service fee, Product XYZ" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="manual-quantity" class="text-purple-700">Qty:</label>
                        <input type="number" id="manual-quantity" value="1" min="0" step="1" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="manual-unit-price" class="text-purple-700">Unit Price ($):</label>
                        <input type="number" id="manual-unit-price" value="0.00" min="0" step="0.01" class="mt-1">
                    </div>
                    <button id="add-manual-item-btn" class="btn btn-primary bg-purple-600 hover:bg-purple-700 mt-2 md:mt-0">Add Item Manually</button>
                </div>

                <div id="invoice-items-management" class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Current Invoice Line Items:</h3>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="w-1/2 text-left p-2">Description</th>
                                <th class="w-1/6 text-left p-2">Qty</th>
                                <th class="w-1/6 text-left p-2">Unit Price</th>
                                <th class="w-1/6 text-left p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="editable-items-body">
                            <!-- Editable items will be injected here -->
                            <tr><td colspan="4" class="text-center text-gray-500 p-4" id="no-items-message">No items added yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Invoice Details Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">3. Invoice Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="client-name" class="text-gray-700">Client Name:</label>
                        <input type="text" id="client-name" placeholder="John Doe Services" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="clientEmail" class="text-gray-700">Customer Email:</label>
                        <input type="email" id="clientEmail" placeholder="customer@example.com" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="invoice-date" class="text-gray-700">Invoice Date:</label>
                        <input type="date" id="invoice-date" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="due-date" class="text-gray-700">Due Date:</label>
                        <input type="date" id="due-date" class="mt-1">
                    </div>
                </div>

                <div class="input-group mb-4">
                    <label for="invoiceDetails" class="text-gray-700">Additional Invoice Notes:</label>
                    <textarea id="invoiceDetails" placeholder="Add any specific notes or terms for this invoice here..." rows="4" class="mt-1"></textarea>
                </div>


                <h3 class="text-xl font-semibold text-gray-700 mb-3">Labor Cost</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="labor-hours" class="text-gray-700">Labor Hours:</label>
                        <input type="number" id="labor-hours" value="0" min="0" step="0.5" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="hourly-rate" class="text-gray-700">Hourly Rate ($):</label>
                        <input type="number" id="hourly-rate" value="30.00" min="0" step="0.01" class="mt-1">
                    </div>
                </div>
            </div>

            <!-- Generate Invoice Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">4. Generate Invoice</h2>
                <button id="generate-invoice-btn" class="btn btn-primary w-full flex items-center justify-center gap-2">
                    Generate Invoice
                    <div id="generate-loading-spinner" class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- Invoice Display Section -->
            <div id="invoice-output" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                    <div>
                        <img id="invoice-company-logo" src="" alt="Company Logo" class="h-16 mb-2 object-contain" onerror="this.style.display='none'" style="display:none;">
                        <h2 class="text-2xl font-bold text-gray-800" id="display-company-name"></h2>
                    </div>
                    <div class="text-right mt-4 md:mt-0">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Invoice</h2>
                        <p class="text-sm text-gray-600"><strong>Client Name:</strong> <span id="display-client-name"></span></p>
                        <p class="text-sm text-gray-600"><strong>Invoice Date:</strong> <span id="display-invoice-date"></span></p>
                        <p class="text-sm text-gray-600"><strong>Due Date:</strong> <span id="display-due-date"></span></p>
                    </div>
                </div>

                <table class="invoice-table w-full border-collapse mt-6">
                    <thead>
                        <tr>
                            <th class="w-1/2">Description</th>
                            <th class="w-1/6">Qty</th>
                            <th class="w-1/6">Unit Price</th>
                            <th class="w-1/6 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="final-invoice-items-body">
                        <!-- Invoice items will be injected here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right">Subtotal:</td>
                            <td class="text-right" id="invoice-subtotal"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-right">Tax:</td>
                            <td class="text-right" id="invoice-tax"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-right font-bold text-lg">Grand Total:</td>
                            <td class="text-right font-bold text-lg" id="invoice-grand-total"></td>
                        </tr>
                    </tfoot>
                </table>
                <!-- Updated Send Invoice Email Button with onclick attribute -->
                <button class="btn btn-primary mt-6 w-full md:w-auto" id="sendEmailButton"
                        onclick="
                            const companyName = document.getElementById('company-name').value.trim();
                            const clientName = document.getElementById('client-name').value.trim();
                            const clientEmail = document.getElementById('clientEmail').value.trim();
                            const invoiceDate = document.getElementById('invoice-date').value;
                            const dueDate = document.getElementById('due-date').value;
                            const grandTotal = document.getElementById('invoice-grand-total').textContent;
                            const additionalNotes = document.getElementById('invoiceDetails').value.trim();

                            if (!clientEmail) { showMessage('Please enter the customer\'s email address.'); return; }
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(clientEmail)) { showMessage('Please enter a valid email address for the customer.'); return; }
                            if (!companyName || !clientName || !invoiceDate || !grandTotal) { showMessage('Please generate the invoice first and ensure all details are filled.'); return; }

                            const subject = `${companyName} - Invoice for ${clientName} on ${invoiceDate}`;
                            let htmlBody = `
                                <html>
                                <head>
                                    <style>
                                        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; }
                                        h1, h2 { color: #6366f1; }
                                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
                                        th { background-color: #f9fafb; font-weight: 600; }
                                        .total-row td { font-weight: bold; }
                                        .text-right { text-align: right; }
                                    </style>
                                </head>
                                <body>
                                    <h1 style='text-align: center;'>Invoice from ${companyName}</h1>
                                    <p><strong>Client Name:</strong> ${clientName}</p>
                                    <p><strong>Invoice Date:</strong> ${invoiceDate}</p>
                                    <p><strong>Due Date:</strong> ${dueDate}</p>
                                    ${additionalNotes ? `<p><strong>Additional Notes:</strong></p><p>${additionalNotes.replace(/\\n/g, '<br>')}</p>` : ''}
                                    
                                    <h2>Invoice Details:</h2>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Description</th>
                                                <th>Qty</th>
                                                <th>Unit Price</th>
                                                <th class='text-right'>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            invoiceLineItems.forEach(item => {
                                const qty = item.quantity || 1;
                                const price = (item.unit_price || 0).toFixed(2);
                                const total = (qty * parseFloat(price)).toFixed(2);
                                htmlBody += `
                                            <tr>
                                                <td>${item.description || 'N/A'}</td>
                                                <td>${qty}</td>
                                                <td>$${price}</td>
                                                <td class='text-right'>$${total}</td>
                                            </tr>
                                `;
                            });

                            const laborHours = parseFloat(document.getElementById('labor-hours').value) || 0;
                            const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
                            const laborTotal = laborHours * hourlyRate;
                            if (laborTotal > 0) {
                                htmlBody += `
                                            <tr>
                                                <td>Labor (${laborHours} hours @ $${hourlyRate.toFixed(2)}/hr)</td>
                                                <td>1</td>
                                                <td>$${laborTotal.toFixed(2)}</td>
                                                <td class='text-right'>$${laborTotal.toFixed(2)}</td>
                                            </tr>
                                `;
                            }

                            htmlBody += `
                                        </tbody>
                                        <tfoot>
                                            <tr class='total-row'>
                                                <td colspan='3' class='text-right'>Subtotal:</td>
                                                <td class='text-right'>${document.getElementById('invoice-subtotal').textContent}</td>
                                            </tr>
                                            <tr class='total-row'>
                                                <td colspan='3' class='text-right'>Tax:</td>
                                                <td class='text-right'>No Tax</td>
                                            </tr>
                                            <tr class='total-row'>
                                                <td colspan='3' class='text-right'>Grand Total:</td>
                                                <td class='text-right'>${grandTotal}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    <p style='margin-top: 20px;'>Please let us know if you have any questions.</p>
                                    <p>Thank you for your business!</p>
                                    <p>${companyName}</p>
                                </body>
                                </html>
                            `;

                            // Call the sendInvoiceEmail function with the generated HTML body
                            sendInvoiceEmail(clientEmail, subject, htmlBody);
                        ">
                    Send Invoice to Customer Email
                </button>
            </div>

            <!-- Message/Modal Box -->
            <div id="message-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="close-modal-btn">&times;</span>
                    <p id="modal-message" class="text-lg text-gray-800 text-center"></p>
                </div>
            </div>

        </div>

        <script>
            // Global variables for Firebase configuration, though not used in this specific app logic
            // as we are not persisting data with Firestore. Included for compliance with general guidelines.
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

            let invoiceLineItems = []; // Unified array to store all invoice items (extracted + manual)
            let companyLogoBase64 = null; // To store the base64 string of the company logo

            // Get DOM elements
            const companyNameInput = document.getElementById('company-name');
            const companyLogoInput = document.getElementById('company-logo');
            const logoPreviewContainer = document.getElementById('logo-preview-container');

            const receiptPhotoInput = document.getElementById('receipt-photo');
            const extractDataBtn = document.getElementById('extract-data-btn');
            const extractLoadingSpinner = document.getElementById('extract-loading-spinner');
            const extractionStatusDiv = document.getElementById('extraction-status');

            const manualDescriptionInput = document.getElementById('manual-description');
            const manualQuantityInput = document.getElementById('manual-quantity');
            const manualUnitPriceInput = document.getElementById('manual-unit-price');
            const addManualItemBtn = document.getElementById('add-manual-item-btn');
            const editableItemsBody = document.getElementById('editable-items-body');
            const noItemsMessage = document.getElementById('no-items-message');


            const clientNameInput = document.getElementById('client-name');
            const clientEmailInput = document.getElementById('clientEmail'); // Updated ID
            const invoiceDateInput = document.getElementById('invoice-date');
            const dueDateInput = document.getElementById('due-date');
            const invoiceDetailsTextarea = document.getElementById('invoiceDetails'); // New: Invoice Details Textarea
            const laborHoursInput = document.getElementById('labor-hours');
            const hourlyRateInput = document.getElementById('hourly-rate'); // Changed default value
            const generateInvoiceBtn = document.getElementById('generate-invoice-btn');
            const generateLoadingSpinner = document.getElementById('generate-loading-spinner');

            const invoiceOutputDiv = document.getElementById('invoice-output');
            const displayCompanyName = document.getElementById('display-company-name');
            const invoiceCompanyLogo = document.getElementById('invoice-company-logo');
            const displayClientName = document.getElementById('display-client-name');
            const displayInvoiceDate = document.getElementById('display-invoice-date');
            const displayDueDate = document.getElementById('display-due-date');
            const finalInvoiceItemsBody = document.getElementById('final-invoice-items-body');
            const invoiceSubtotal = document.getElementById('invoice-subtotal');
            const invoiceTax = document.getElementById('invoice-tax');
            const invoiceGrandTotal = document.getElementById('invoice-grand-total');
            // The sendInvoiceEmailBtn is now directly handled by its onclick attribute in HTML
            // const sendInvoiceEmailBtn = document.getElementById('send-invoice-email-btn');


            const messageModal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // Set default dates and company name
            window.onload = function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(today.getDate()).padStart(2, '0');
                invoiceDateInput.value = `${year}-${month}-${day}`;

                // Set due date to 7 days from now
                const dueDate = new Date();
                dueDate.setDate(today.getDate() + 7);
                const dueYear = dueDate.getFullYear();
                const dueMonth = String(dueDate.getMonth() + 1).padStart(2, '0');
                const dueDay = String(dueDate.getDate()).padStart(2, '0');
                dueDateInput.value = `${dueYear}-${dueMonth}-${dueDay}`;
                renderEditableItems(); // Initial render for empty state
            };

            // Function to show custom message modal
            function showMessage(message) {
                modalMessage.textContent = message;
                // Changed from 'flex' to 'block' with additional CSS for proper centering and display
                messageModal.style.display = 'flex';
                // Ensure the modal content is vertically centered
                messageModal.style.alignItems = 'center';
                messageModal.style.justifyContent = 'center';
                modalMessage.style.textAlign = 'center'; // Center the text within the modal
            }

            // Function to hide custom message modal
            closeModalBtn.onclick = function() {
                messageModal.style.display = 'none';
            }

            // Close modal if user clicks outside of it
            window.onclick = function(event) {
                if (event.target == messageModal) {
                    messageModal.style.display = 'none';
                }
            }

            // Function to render the editable invoice items table
            function renderEditableItems() {
                editableItemsBody.innerHTML = ''; // Clear current list
                if (invoiceLineItems.length === 0) {
                    noItemsMessage.style.display = 'table-row';
                } else {
                    noItemsMessage.style.display = 'none';
                    invoiceLineItems.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'editable-item-row border-b border-gray-100';
                        row.innerHTML = `
                            <td><input type="text" value="${item.description || ''}" data-index="${index}" data-field="description" class="p-2 border rounded-md w-full"></td>
                            <td><input type="number" value="${item.quantity || 1}" min="1" step="1" data-index="${index}" data-field="quantity" class="p-2 border rounded-md w-full"></td>
                            <td><input type="number" value="${(item.unit_price || 0).toFixed(2)}" min="0" step="0.01" data-index="${index}" data-field="unit_price" class="p-2 border rounded-md w-full"></td>
                            <td><button data-index="${index}" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md">Delete</button></td>
                        `;
                        editableItemsBody.appendChild(row);
                    });

                    // Add event listeners for editing and deleting
                    editableItemsBody.querySelectorAll('input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            const field = e.target.dataset.field;
                            let value = e.target.value;

                            if (field === 'quantity' || field === 'unit_price') {
                                value = parseFloat(value) || 0;
                                if (field === 'quantity' && value < 1) value = 1; // Ensure quantity is at least 1
                                if (field === 'unit_price' && value < 0) value = 0; // Ensure unit price is not negative
                            }
                            invoiceLineItems[index][field] = value;
                            // Recalculate total_price if quantity or unit_price changes
                            invoiceLineItems[index].total_price = (invoiceLineItems[index].quantity || 0) * (invoiceLineItems[index].unit_price || 0);
                            // No re-render here, as changes are live in the input fields. The final generation will use the updated `invoiceLineItems`.
                        });
                    });

                    editableItemsBody.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            invoiceLineItems.splice(index, 1); // Remove item from array
                            renderEditableItems(); // Re-render the list to reflect deletion
                        });
                    });
                }
            }


            // Event listener for company logo input
            companyLogoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        companyLogoBase64 = e.target.result; // Store base64
                        const img = document.createElement('img');
                        img.src = companyLogoBase64;
                        img.alt = "Company Logo Preview";
                        img.className = "h-12 object-contain rounded"; // Tailwind classes for preview
                        logoPreviewContainer.innerHTML = ''; // Clear previous preview
                        logoPreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else {
                    companyLogoBase64 = null;
                    logoPreviewContainer.innerHTML = '';
                }
            });

            // Event listener for manual item addition
            addManualItemBtn.addEventListener('click', () => {
                const description = manualDescriptionInput.value.trim();
                const quantity = parseFloat(manualQuantityInput.value) || 1;
                const unitPrice = parseFloat(manualUnitPriceInput.value) || 0;

                if (!description || quantity <= 0 || unitPrice < 0) {
                    showMessage("Please enter a valid description, quantity (must be > 0), and unit price for manual item.");
                    return;
                }

                const newItem = {
                    description: description,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total_price: quantity * unitPrice // Calculate total for manual item
                };

                invoiceLineItems.push(newItem);
                renderEditableItems(); // Update the display
                manualDescriptionInput.value = '';
                manualQuantityInput.value = '1';
                manualUnitPriceInput.value = '0.00';
            });

            // Event listener for receipt photo upload and data extraction
            extractDataBtn.addEventListener('click', async () => {
                const file = receiptPhotoInput.files[0];
                if (!file) {
                    showMessage("Please upload a receipt photo first.");
                    return;
                }

                extractDataBtn.disabled = true;
                extractLoadingSpinner.classList.remove('hidden');
                extractionStatusDiv.textContent = 'Extracting data... This may take a moment.';
                extractionStatusDiv.classList.remove('text-red-600', 'text-green-600');
                extractionStatusDiv.classList.add('text-gray-600');


                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64ImageData = reader.result.split(',')[1]; // Get base64 string without data:image/jpeg;base64,

                    try {
                        // Enhanced prompt for AI to extract structured data from the image
                        const prompt = `Analyze the provided receipt image. Your primary goal is to extract itemized lists (description, quantity, unit price, and total price for each item), along with the overall subtotal, tax, and grand total.
                        * **Be resilient to image quality:** Even if parts are blurry or incomplete, attempt to infer the most probable values.
                        * **Prioritize numerical accuracy:** All price, quantity, and total fields MUST be valid numbers (floats). If a numerical value cannot be confidently extracted or inferred, use 0.
                        * **Handle missing data:** If a description, quantity, or unit price for an item is missing, use "N/A" for strings, or 0 for numbers, but still include the item if its existence is clear.
                        * **Strict JSON Format:** Your response MUST be a JSON object conforming to this schema, even if some values are null/0 or the 'items' array is empty:
                            {
                              "items": [
                                {"description": "string", "quantity": number, "unit_price": number, "total_price": number}
                              ],
                              "subtotal": number,
                              "tax": number,
                              "grand_total": number
                            }
                        Example of expected output if a receipt has two items and a total:
                        {
                          "items": [
                            {"description": "Espresso", "quantity": 2, "unit_price": 3.50, "total_price": 7.00},
                            {"description": "Croissant", "quantity": 1, "unit_price": 4.25, "total_price": 4.25}
                          ],
                          "subtotal": 11.25,
                          "tax": 0.89,
                          "grand_total": 12.14
                        }
                        Example of expected output if very little can be extracted but the receipt seems to contain items:
                        {
                          "items": [
                            {"description": "Item 1 (inferred)", "quantity": 1, "unit_price": 0, "total_price": 0}
                          ],
                          "subtotal": 0,
                          "tax": 0,
                          "grand_total": 0
                        }`;

                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = {
                            contents: [
                                {
                                    role: "user",
                                    parts: [
                                        { text: prompt },
                                        {
                                            inlineData: {
                                                mimeType: file.type,
                                                data: base64ImageData
                                            }
                                        }
                                    ] // Corrected: This bracket was misplaced or extra
                                }
                            ], // Corrected: This comma was missing and the curly brace above was closing too early
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        "items": {
                                            "type": "ARRAY",
                                            "items": {
                                                "type": "OBJECT",
                                                "properties": {
                                                    "description": { "type": "STRING" },
                                                    "quantity": { "type": "NUMBER" },
                                                    "unit_price": { "type": "NUMBER" },
                                                    "total_price": { "type": "NUMBER" }
                                                }
                                            }
                                        },
                                        "subtotal": { "type": "NUMBER" },
                                        "tax": { "type": "NUMBER" },
                                        "grand_total": { "type": "NUMBER" }
                                    }
                                }
                            }
                        };

                        const apiKey = ""; // Canvas will provide this at runtime
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const parsedData = JSON.parse(jsonText);

                            const newlyExtractedItems = parsedData.items || [];

                            if (newlyExtractedItems.length > 0) {
                                // Add extracted items to the unified list
                                invoiceLineItems.push(...newlyExtractedItems);
                                extractionStatusDiv.textContent = `Successfully extracted ${newlyExtractedItems.length} items. Review and edit below.`;
                                extractionStatusDiv.classList.add('text-green-600');
                            } else {
                                extractionStatusDiv.textContent = "No specific items extracted. This can happen with very unclear photos. Please try a clearer one or add items manually below.";
                                extractionStatusDiv.classList.remove('text-green-600');
                                extractionStatusDiv.classList.add('text-red-600');
                            }
                            renderEditableItems(); // Update the displayed editable list

                        } else {
                            showMessage("Could not extract data. The AI response was empty or malformed. Please try another receipt or ensure clarity.");
                            extractionStatusDiv.textContent = "Extraction failed: Empty or malformed AI response. Please try a clearer photo or add items manually.";
                            extractionStatusDiv.classList.remove('text-green-600');
                            extractionStatusDiv.classList.add('text-red-600');
                        }
                    } catch (error) {
                        console.error('Error extracting data:', error);
                        showMessage("An error occurred during data extraction. Please ensure the image is a valid receipt and try again. Error: " + error.message);
                        extractionStatusDiv.textContent = "Extraction error. Please try again with a clear photo or add items manually.";
                        extractionStatusDiv.classList.remove('text-green-600');
                        extractionStatusDiv.classList.add('text-red-600');
                    } finally {
                        extractDataBtn.disabled = false;
                        extractLoadingSpinner.classList.add('hidden');
                    }
                };
                reader.readAsDataURL(file);
            });

            // Event listener for invoice generation
            generateInvoiceBtn.addEventListener('click', () => {
                generateInvoiceBtn.disabled = true;
                generateLoadingSpinner.classList.remove('hidden');
                invoiceOutputDiv.classList.add('hidden'); // Hide previous invoice

                const companyName = companyNameInput.value.trim();
                const clientName = clientNameInput.value.trim();
                const invoiceDate = invoiceDateInput.value;
                const dueDate = dueDateInput.value;
                const laborHours = parseFloat(laborHoursInput.value) || 0;
                const hourlyRate = parseFloat(hourlyRateInput.value) || 0;

                if (!companyName || !clientName || !invoiceDate || !dueDate) {
                    showMessage("Please fill in all required invoice details (Company Name, Client Name, Invoice Date, Due Date).");
                    generateInvoiceBtn.disabled = false;
                    generateLoadingSpinner.classList.add('hidden');
                    return;
                }

                if (invoiceLineItems.length === 0 && (laborHours * hourlyRate) === 0) {
                     showMessage("Please add at least one item (manual or extracted) or provide labor hours to generate an invoice.");
                     generateInvoiceBtn.disabled = false;
                     generateLoadingSpinner.classList.add('hidden');
                     return;
                }

                // Calculate labor total
                const laborTotal = laborHours * hourlyRate;

                // Clear previous items in the final invoice display
                finalInvoiceItemsBody.innerHTML = '';

                let materialSubtotal = 0;

                // Add all items from invoiceLineItems to the final invoice
                if (invoiceLineItems.length > 0) {
                    invoiceLineItems.forEach(item => {
                        const quantity = item.quantity || 1;
                        const unitPrice = item.unit_price || 0;
                        const itemTotalPrice = quantity * unitPrice;

                        materialSubtotal += itemTotalPrice;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.description || 'N/A'}</td>
                            <td>${quantity}</td>
                            <td>$${unitPrice.toFixed(2)}</td>
                            <td class="text-right">$${itemTotalPrice.toFixed(2)}</td>
                        `;
                        finalInvoiceItemsBody.appendChild(row);
                    });
                }

                // Add labor cost as an item if applicable
                if (laborTotal > 0) {
                    const laborRow = document.createElement('tr');
                    laborRow.innerHTML = `
                        <td>Labor (${laborHours} hours @ $${hourlyRate.toFixed(2)}/hr)</td>
                        <td>1</td>
                        <td>$${laborTotal.toFixed(2)}</td>
                        <td class="text-right">$${laborTotal.toFixed(2)}</td>
                    `;
                    finalInvoiceItemsBody.appendChild(laborRow);
                } else if (invoiceLineItems.length === 0) {
                     // If no items extracted and no labor, show a message in the invoice itself
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="4" class="text-center text-gray-500">No items to display on invoice.</td>
                    `;
                    finalInvoiceItemsBody.appendChild(row);
                }


                const subtotal = materialSubtotal + laborTotal;
                // Tax is now 0 as per user request
                const tax = 0; 
                const grandTotal = subtotal + tax;

                // Populate invoice display with company name and logo
                displayCompanyName.textContent = companyName;
                if (companyLogoBase64) {
                    invoiceCompanyLogo.src = companyLogoBase64;
                    invoiceCompanyLogo.style.display = 'block';
                } else {
                    invoiceCompanyLogo.style.display = 'none'; // Hide if no logo
                }
                displayClientName.textContent = clientName;
                displayInvoiceDate.textContent = invoiceDate;
                displayDueDate.textContent = dueDate;
                invoiceSubtotal.textContent = `$${subtotal.toFixed(2)}`;
                invoiceTax.textContent = `No Tax`; // Display "No Tax"
                invoiceGrandTotal.textContent = `$${grandTotal.toFixed(2)}`;

                invoiceOutputDiv.classList.remove('hidden');

                generateInvoiceBtn.disabled = false;
                generateLoadingSpinner.classList.add('hidden');
            });

            // The user-provided sendInvoiceEmail function, modified to use showMessage
            async function sendInvoiceEmail(toEmail, subject, bodyContent) {
                try {
                    console.log('Attempting to send email...');
                    console.log('To:', toEmail);
                    console.log('Subject:', subject);
                    // console.log('Body (HTML):', bodyContent); // Log the full body for debugging if needed

                    // IMPORTANT: Updated the fetch URL to your Vercel backend
                    const response = await fetch('https://invoice-generator-app-taupe.vercel.app/api/sendEmail', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: toEmail,
                            subject: subject,
                            body: bodyContent // Sending HTML content here
                        }),
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (response.ok) {
                        showMessage(data.message || 'Email sent successfully!');
                        console.log('Email send success:', data.message);
                    } else {
                        showMessage(`Failed to send email: ${data.message || response.statusText}. Please check Vercel logs.`);
                        console.error('Email send failed (frontend received error from backend):', data.message || response.statusText);
                    }
                } catch (error) {
                    console.error('Email send failed (frontend fetch error):', error);
                    showMessage('Failed to send email. A network error or unhandled problem occurred. Check browser console.');
                }
            }

            // The previous event listener for sendInvoiceEmailBtn is removed because onclick is now used.
            // const sendInvoiceEmailBtn = document.getElementById('send-invoice-email-btn');
            // if (sendInvoiceEmailBtn) { sendInvoiceEmailBtn.addEventListener('click', () => { ... }); }
        </script>
    </body>
    </html>
